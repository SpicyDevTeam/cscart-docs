==========================
Тинькофф для маркетплейсов
==========================

.. note:: 

    В "CS-Cart для маркетплейсов" 4.16.1 появилась возможность принимать оплату через Тинькофф. 

В данной статье рассмотрим процесс настройки способа оплаты с возможностью автоматического распределения средств, полученных через Тинькофф. :doc:`Подробнее об остальных возможностях </user_guide/addons/tinkoff/index>`, которые появились благодаря интеграции с Тинькофф.

Перед началом настройки способа оплаты в панели администратора, владелец маркетплейса должен `связаться с менеджером банка Тинькофф <https://www.tinkoff.ru/business/payments/>`_ для заключения договора и получения доступа в личный кабинет. Обычно после подачи заявки и подписания договора банку требуется пара дней для создания маркетплейса в вашем личном кабинете. Когда личный кабинет и маркетплейс созданы, можно приступать к настройке на стороне CS-Cart. 

1. Установите модуль “Тинькофф Сплитование [Beta]” на странице **Модули → Скачанные модули**.

2. Перейдите на страницу **Администрирование → Способы оплаты**.

3. Добавьте новый способ оплаты, нажав на **+** в верхней правой части страницы.

4. Заполнить поля, перемещаясь по вкладкам.

Вкладка *Общее*
---------------

Главное выбрать в качестве **Процессора** Tinkoff Multiparty из списка *Российских способов оплаты*. Остальные поля заполняются :doc:`в соответствии с их значениями </user_guide/payment_methods/configure_payment>`. 

Вкладка *Настроить*
-------------------

1) Из раздела **Информация** скопируйте самую первую ссылку “URL для уведомлений” — ссылка на страницу, которая принимает сообщения об успешной оплате, ошибках и другую нотификацию. 

.. fancybox:: img/URLs_marketplace.png
     :alt: Раздел "Информация" в настройках способа оплаты с процессором Tinkoff Multiparty.

2) Далее перейдите в личный кабинет “Тинькофф бизнес” и откройте вкладку `Интернет-эквайринг → Магазины <https://business.tinkoff.ru/oplata/mpa/merchant/eacq>`_. Кликните по названию вашего маркетплейса. Справа вы увидите несколько вкладок с настройками и полезными данными: *О магазине*, *Способы оплаты*, *Тариф*, *Терминалы*, *Онлайн-касса*. 

   Так на вкладке *Способы оплаты* указаны доступные способы оплаты. На момент выхода CS-Cart 4.16.1 с интеграцией с Тинькофф действуют банковские карты, СБП и оплата по QR-кодам.  

.. fancybox:: img/tabs.png
    :alt: Вкладки в ЛК Тинькофф на странице маркетплейса.

3) Откройте вкладку *Терминалы* и настройте рабочий терминал. В разделе **Уведомления** вставьте скопированную ссылку для уведомлений. 

4) Далее скопируйте из панели администратора URL для удавшихся платежей и вставьте в поле для ссылки на страницу успеха. То же самое и с третьей ссылкой: URL для неудавшихся платежей вставьте в поле для страницы ошибки. 

5) Остальные настройки на странице настроек терминала оставьте по умолчанию. Сохраните изменения.

6) Оставаясь на странице с настройками терминала последовательно скопируйте номер терминала и пароль  из окошка справа и вставьте в поля **Терминал** и **Пароль** в настройках способа оплаты панели администратора. 

.. fancybox:: img/number_password.png
    :alt:  Настройка рабочего терминала в ЛК Тинькофф; информация о номере и пароле терминала.

7) Следующие данные обязательны для заполнения при настройке способа оплаты в панели администратора, но их нет в личном кабинете. Вы получите их от менеджера банка.

   Поля **Имя пользователя в SM-Register** и **Пароль в SM-Register** отвечают за регистрацию продавцов в системе распределения платежей. 

   Поля **Номер договора с банком** и **Дата договора с банком** используются в расчётной ведомости (сколько денег перевели и когда), которая отправляется продавцам. 

8) Теперь идут настройки, связанные с формированием чеков. 

   Чекбокс **Отправлять чек** — отметьте, если хотите отсылать чеки в Тинькофф. Обычно касса отправляет два чека:

   * Чек на предоплату, когда списали деньги с карты.

   * Закрывающий чек, когда оказали услугу или отправили товар. 

   Чтобы передача чеков заработала, онлайн-кассу следует активировать. Для этого откройте вкладку *Онлайн-касса* в личном кабинете Тинькофф, заполните поля для её настройки — данные об онлайн-кассе появляются у владельца при получении кассы (приобретите самостоятельно или через Тинькофф).

   **ИНН маркетплейса** — введите ИНН своего маркетплейса, это необходимо для отправки чеков.

   **Статус заказа для отправки закрывающего чека** — статус заказа после доставки товара и полного оказания услуги.

   **Тип оплаты** — выберите, как именно будут списываться средства с карты покупателя. 

   * *Оплата в два шага*

     1. Заказ создается в статусе “Открыт”.

     2. Деньги сначала резервируются (холдируются) на стороне банка, заказ остается в статусе "Открыт".

     3. На странице заказа в админке появляется кнопка для перевода средств — при нажатии деньги списываются с карты, а статус заказа меняется на “Обработан”.

     Полезно для ситуаций, связанными с возвратами. Если вдруг покупатель после оплаты отказался от товара и запросил возврат средств, то вы сможете не платить комиссию по этому платежу благодаря замораживанию средств на счёте клиента в течение семи дней после покупки (холдирование). Удобно, когда например покупатель решил вернуть одну из трёх заказанных футболок — состав заказа изменится, сумма уменьшиться, и вы заплатите комиссию только по конечной сумме.

   * При *оплате в один шаг* сразу после размещения заказа списываются деньги с карты и статус заказа становится “Обработан”.

   **Налоговая система** — выберите выгодный `налоговый режим для торговли <https://secrets.tinkoff.ru/biznes-s-nulya/nalogooblozhenie-roznica/>`_.

   **Версия ФФД** — формат фискальных документов, по которому ваша касса создает чеки.

**Сохраните** измененения в созданном способе оплаты.

После того, как вы заполнили и настроили все поля в настройках способа оплаты в панели администратора, необходимо зарегистрировать продавцов.

.. _vendor-registration:

Регистрация продавцов
---------------------

За регистрацию продавцов отвечает администратор маркетплейса, но все необходимые данные продавец заполняет самостоятельно на отдельной вкладке. **Форма регистрации учётной записи Тинькофф** находится на вкладке *Тинькофф Сплитование* на странице "Информация о продавце".

Все поля в этой форме обязательны для заполнения, проверок на корректность там нет. Отдельно на вкладке *Модули* продавец должен выбрать тип агента — того, на кого ляжет налоговая нагрузка. Выбор зависит от схемы работы маркетплейса: например, вариант по-умолчанию, “Платёжный агент”, подойдет большинству B2C маркетплейсов. 

.. fancybox:: img/vendor_info.png
    :alt: Вкладка *Тинькофф Сплитование* и форма регистрации учётной записи Тинькофф в панели продавца.

Администратору маркетплейса рекомендуется проверить данные, заполненные продавцом. Для этого в панели администратора перейдите на вкладку *Тинькофф сплитование* на странице продавца. После проверки нажмите **Зарегистрировать продавца**.

Если всё заполнено правильно, то в ответ страница получит и отобразит **ShopCode** — обязательный параметр для работы сплитования.

.. fancybox:: img/register_vendor.png
    :alt: Кнопка "Зарегистрировать продавца" в панели администратора.

.. fancybox:: img/shopcode.png
    :alt: ShopCode после регистрации продавца.

Всё готово! Можно начать продавать и принимать оплату через Тинькофф с автоматическим сплитованием платежей. 

.. fancybox:: img/tinkoff_multiparty_payment.png
    :alt: Tinkoff Multiparty на странице оформления заказа.