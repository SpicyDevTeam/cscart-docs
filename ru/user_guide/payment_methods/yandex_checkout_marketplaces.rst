*******************
ЮKassa для платформ
*******************

.. hint::

    Поддержка сплитования впервые появилась в версии Multi-Vendor 4.11.4 SP3.
    
Принцип работы
==============

#. Покупатель добавляет в корзину товары от разных продавцов.

#. На странице оформления заказа покупатель выбирает способ оплаты “ЮKassa для платформ”.

#. При нажатии кнопки “Оформить заказ” он попадает на страницу ЮKassa, и уже там выбирает `подходящий способ оплаты <https://yookassa.ru/docs/support/payments/accept-methods>`_.

   .. fancybox:: /user_guide/addons/yandex_checkout/img/payment_yandex.png
       :alt: Способы оплаты Яндекса и поля для ввода данных банковской карты.

   .. note::
       Такой принцип работы описан на сайте ЮKassa как `"Сценарий 1: Выбор способа оплаты на странице Кассы" <https://yookassa.ru/pay_by_yookassa/#1>`_. Его преимущество в том, что `когда ЮKassa добавит новые способы оплаты, то и вы сможете их быстро добавить <https://yookassa.ru/docs/support/payments/accept-methods#accept-methods__adding-new>`_.

#. Покупатель платит всего один раз, а ЮKassa сама производит сплитование и отправляет деньги продавцам. Комиссия перечисляется владельцу маркетплейса.

Настройка
=========

.. important::
    Для работы с ЮKassa `на вашем сервере должен быть установлен SSL-сертификат <https://yookassa.ru/docs/payment-solution/supplementary/security>`_. Можно использовать самоподписанный сертификат.



Шаг 1. Настройте способ оплаты
------------------------------

#. Установите модуль :doc:`/user_guide/addons/yandex_checkout/index`.

#. `Подключите ваш маркетплейс к ЮKassa. <https://yookassa.ru/joinups/?source=cscart>`_

   .. note::
   
       Обратите внимание, что ЮKassa может предъявлять свои требования к маркетплейсам. На момент написания статьи подключение к ЮKassa для платформ доступно только для компаний с оборотом от 700 тыс. рублей в месяц. Со временем требования могут меняться, с актуальными условиями вы можете ознакомиться на `сайте ЮKassa <https://yookassa.ru/marketplaces/>`_.
       
   .. fancybox:: img/yandex_requirements.png
       :alt: Требования к маркетплейсам на стороне Яндекса

#. :doc:`Создайте новый cпособ оплаты <adding_payment>` с процессором *ЮKassa для платформ*.

#. Перейдите на вкладку **Настроить** нового способа оплаты и выполните настройку:

   .. fancybox:: img/add_payment_method_yandex_for_marketplace.png
       :alt: Редактирование способа оплаты Яндекс.Касса для платформ.

   * **URL для уведомлений** — скопируйте его отсюда в настройки магазина в личном кабинете ЮKassa. Так ЮKassa будет знать, куда сообщать о транзакциях.

   * **shopId** и **секретный ключ** — возьмите их из личного кабинета ЮKassa и скопируйте сюда. Так ЮKassa точно будет знать, что это именно ваш маркетплейс.

   * **Отправлять данные для чеков в ЮKassa (54-ФЗ)** — включите эту настройку, если за взаимодействие с онлайн-кассой у вас отвечает ЮKassa.

   * **Статус заказа для формирования итогового чека** — статус заказа, когда покупатель получил то, за что заплатил. Когда заказ получает этот статус, ЮKassa сформирует чек зачёта предоплаты.

   * **Валюта** — выберите валюту, которая используется в учётной записи ЮKassa. Она должна совпадать с базовой валютой вашего маркетплейса.

#. Нажмите кнопку **Сохранить**.

Шаг 2. Добавьте продавцов
-------------------------

#. Убедитесь, что продавцы подключены к ЮKassa. Запросите их идентификаторы.

#. Откройте вкладку **Продавцы**.

#. Щелкните по названию продавца, чтобы открыть его настройки, и откройте вкладку **Модули**.

   .. fancybox:: img/add_new_vendor.png
       :alt: Ввод идентификатора и комиссии в настройках продавца.

#. В поле **shopId** введите идентификатор продавца.

#. В поле **Тип комиссии** выберите тип комиссии, указанный в вашем соглашении с ЮKassa:

   * **Фиксированная** — тип комиссии, который отменяет все другие комиссии, установленные в вашем маркетплейсе.
   
   * **Гибкая** — тип комиссии, который позволяет применять разные значения комиссии для разных тарифных планов.
   
   .. important::
   
       Вне зависимости от выбранного типа комиссии, для ее расчёта необходим установленный и включенный модуль :doc:`/user_guide/addons/vendor_plans/index`.
   
#. В поле **Комиссия маркетплейса** введите значение, указанное в вашем договоре с ЮKassa. Поле активно только в случае, если выбран тип комиссии **Фиксированная**.

#. Нажмите **Сохранить**.

   .. note::
       Способ оплаты “ЮKassa для платформ” будет доступен покупателю, только если все продавцы, чьи товары у него в корзине, подключены к ЮKassa.
